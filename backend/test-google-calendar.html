<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Calendar Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .endpoint {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            font-family: monospace;
        }
        .setup-instruction {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóìÔ∏è Google Calendar Integration Test</h1>
        
        <div class="setup-instruction">
            <h3>‚öôÔ∏è Setup Required:</h3>
            <p>Before testing, make sure you have:</p>
            <ol>
                <li>Set up Google Cloud Console project</li>
                <li>Enabled Google Calendar API</li>
                <li>Created OAuth 2.0 credentials</li>
                <li>Updated .env file with credentials</li>
                <li>Run database migration for tokens table</li>
                <li>Restarted the server</li>
            </ol>
            <p><strong>Current Backend URL:</strong> <code>http://localhost:3001</code></p>
        </div>

        <div id="status"></div>

        <h2>üîß Available Tests</h2>
        
        <button onclick="testGoogleStatus()">Check Google Calendar Status</button>
        <button onclick="testCalendarEndpoints()">Test Calendar Endpoints</button>
        <button onclick="getAuthUrl()" id="authBtn" disabled>Get Google Auth URL</button>
        <button onclick="testICSExport()">Test ICS Export</button>
        
        <h2>üì° API Endpoints</h2>
        <div class="endpoint">GET /api/v1/calendar/google/status</div>
        <div class="endpoint">GET /api/v1/calendar/google/auth-url</div>
        <div class="endpoint">GET /api/v1/calendar/google/callback</div>
        <div class="endpoint">GET /api/v1/calendar/google/calendars</div>
        <div class="endpoint">GET /api/v1/calendar</div>
        <div class="endpoint">GET /api/v1/calendar/bookings/ics</div>

        <h2>üìã Test Results</h2>
        <div id="results"></div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:3001/api/v1';
        let isConfigured = false;

        // Show status message
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // Show test results
        function showResult(title, data, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultHtml = `
                <div class="status ${type}">
                    <h4>${title}</h4>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
            resultsDiv.innerHTML += resultHtml;
        }

        // Make API call
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${BASE_URL}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        // Note: You'll need to add Authorization header for protected endpoints
                        // 'Authorization': 'Bearer YOUR_JWT_TOKEN'
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                return { success: response.ok, data, status: response.status };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // Test Google Calendar configuration status
        async function testGoogleStatus() {
            showStatus('Testing Google Calendar configuration...', 'info');
            
            const result = await apiCall('/calendar/google/status', {
                headers: {
                    // This endpoint requires authentication - you'll need a valid JWT token
                    // 'Authorization': 'Bearer YOUR_JWT_TOKEN_HERE'
                }
            });
            
            if (result.success) {
                isConfigured = result.data.configured;
                document.getElementById('authBtn').disabled = !isConfigured;
                
                if (result.data.configured) {
                    showStatus('‚úÖ Google Calendar is properly configured!', 'success');
                    showResult('Google Calendar Status', result.data, 'success');
                } else {
                    showStatus('‚ö†Ô∏è Google Calendar not configured. Check your .env file.', 'warning');
                    showResult('Google Calendar Status', result.data, 'warning');
                }
            } else {
                showStatus(`‚ùå Failed to check status: ${result.error || 'Unknown error'}`, 'error');
                showResult('Error', result, 'error');
            }
        }

        // Test basic calendar endpoints
        async function testCalendarEndpoints() {
            showStatus('Testing calendar endpoints...', 'info');
            
            // Test calendar events endpoint
            const eventsResult = await apiCall('/calendar');
            showResult('Calendar Events', eventsResult, eventsResult.success ? 'success' : 'error');
        }

        // Get Google Calendar authorization URL
        async function getAuthUrl() {
            if (!isConfigured) {
                showStatus('Google Calendar not configured. Run status check first.', 'warning');
                return;
            }
            
            showStatus('Getting Google Calendar authorization URL...', 'info');
            
            const result = await apiCall('/calendar/google/auth-url');
            
            if (result.success && result.data.authUrl) {
                showStatus('‚úÖ Auth URL generated! Click to authorize Google Calendar.', 'success');
                showResult('Authorization URL', result.data, 'success');
                
                // Create clickable link
                const authDiv = document.createElement('div');
                authDiv.className = 'status success';
                authDiv.innerHTML = `
                    <h4>üîó Click to Authorize Google Calendar:</h4>
                    <a href="${result.data.authUrl}" target="_blank" style="color: #155724; font-weight: bold;">
                        Authorize Google Calendar Access
                    </a>
                    <p><small>After authorization, you'll be redirected back to the app.</small></p>
                `;
                document.getElementById('results').appendChild(authDiv);
            } else {
                showStatus('‚ùå Failed to get authorization URL', 'error');
                showResult('Error', result, 'error');
            }
        }

        // Test ICS export
        async function testICSExport() {
            showStatus('Testing ICS export...', 'info');
            
            const result = await apiCall('/calendar/bookings/ics');
            
            if (result.success) {
                showStatus('‚úÖ ICS export working!', 'success');
                showResult('ICS Export', result.data, 'success');
            } else {
                showStatus('‚ùå ICS export failed', 'error');
                showResult('ICS Export Error', result, 'error');
            }
        }

        // Check if we're coming back from Google OAuth
        function checkOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            
            if (code) {
                showStatus('‚úÖ OAuth authorization successful! Code received from Google.', 'success');
                showResult('OAuth Callback', { code: code.substring(0, 20) + '...', state }, 'success');
            }
        }

        // Initialize page
        window.onload = function() {
            showStatus('üöÄ Google Calendar Integration Test Page Loaded', 'info');
            checkOAuthCallback();
            
            // Add info about authentication requirement
            const infoDiv = document.createElement('div');
            infoDiv.className = 'status warning';
            infoDiv.innerHTML = `
                <h4>üîê Authentication Required:</h4>
                <p>Most endpoints require JWT authentication. To fully test:</p>
                <ol>
                    <li>Login via your app to get a JWT token</li>
                    <li>Update the apiCall function with your token</li>
                    <li>Re-run the tests</li>
                </ol>
                <p>For now, you can test the server connectivity and configuration.</p>
            `;
            document.getElementById('status').appendChild(infoDiv);
        };
    </script>
</body>
</html>